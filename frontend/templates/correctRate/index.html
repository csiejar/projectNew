<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>答對率統計圖表</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', path='/correctRate/styles.css') }}">
  <script src="{{ url_for('static', path='/correctRate/script.js') }}"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #f3f4f6, #e5e7eb);
      color: #111827;
    }

    #chart-container {
      max-width: 1400px;
      margin: 60px auto;
      background: white;
      padding: 60px 50px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      font-weight: 700;
      font-size: 36px;
      margin-bottom: 40px;
      color: #1f2937;
    }

    progress {
      width: 100%;
      height: 20px;
      margin-bottom: 30px;
      appearance: none;
    }

    progress::-webkit-progress-bar {
      background-color: #e5e7eb;
      border-radius: 10px;
    }

    progress::-webkit-progress-value {
      background: linear-gradient(to right, #10b981, #22d3ee);
      border-radius: 10px;
    }

    #loading-area {
      text-align: center;
      margin-bottom: 30px;
    }

    /* Spinner (轉圈圈) */
    .spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #ccc;
      border-top: 4px solid #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #loading-message {
      font-size: 18px;
      color: #6b7280;
      display: inline-block;
      vertical-align: middle;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    @media (max-width: 768px) {
      #chart-container {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar collapsed" id="sidebar">
    <div class="sidebar-logo">
      <img src="../static/img/mark.png" alt="Logo">
    </div>
    <ul>
      <li id="mainPageSideBar"><i class="bi bi-house"></i><span class="text">首頁</span></li>
      <li id="questionBankSideBar"><i class="bi bi-book"></i><span class="text">題庫</span></li>
      <li id="demoTestSideBar"><i class="bi bi-pencil"></i><span class="text">模擬測驗</span></li>
      <li id="WrongQuestionBookSideBar"><i class="bi bi-journal-x"></i><span class="text">錯題本</span></li>
    </ul>
  </div>
  <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

  <!-- Header -->
  <header class="d-flex align-items-center justify-content-between p-3 bg-white text-dark">
    <button class="btn text-dark" id="menuBtn">☰</button>
    <img src="../static/img/logo.png" alt="Logo" style="height: 50px;" onclick="location.href='/'">
    <div>
      <button class="btn btn-outline-dark" id="google-translate">
        <i class="bi bi-globe"></i>
      </button>
      <div id="google_translate_element"
        style="display: none; position: absolute; top: 80px; right: 0px; z-index: 10000;"></div>
      <script type="text/javascript">
        document.getElementById('google_translate_element').style.display = 'none';
        function googleTranslateElementInit() {
          new google.translate.TranslateElement({
            pageLanguage: 'zh-TW',
            includedLanguages: 'en,zh-CN,zh-TW',
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE
          }, 'google_translate_element');
        }
        document.getElementById('google-translate').addEventListener('click', function () {
          const translateElement = document.getElementById('google_translate_element');
          translateElement.style.display = translateElement.style.display === 'none' ? 'block' : 'none';
        });
      </script>
      <script type="text/javascript"
        src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
      <button class="btn btn-outline-dark" id="userBtn">
        <i class="bi bi-person-circle"></i>
      </button>
    </div>
  </header>

  <div id="chart-container">
    <h1>使用者各題答對率統計</h1>

    <div id="loading-area">
      <div class="spinner"></div>
      <span id="loading-message">請稍後一下，可能需要一段時間...</span>
    </div>

    <progress id="loading" value="0" max="100"></progress>
    <canvas id="myChart"></canvas>
  </div>
  <!-- 放在 body 的最下方，footer 之前 -->
<div class="overlay" id="userInfoOverlay" style="display: none;">
  <div class="popup-card">
    <button class="close-btn" id="closeUserCard">✕</button>
    <img id="userAvatar" src="" alt="使用者頭像" class="avatar">
    <div class="name" id="userName">使用者姓名</div>
    <div class="email" id="userEmail">使用者 Gmail</div>
    <div id="g_id_onload" data-client_id="1071265157577-7bcbr8qejtvtbmnchgs06ohr9ke46v97.apps.googleusercontent.com"
      data-callback="handleCredentialResponse" data-auto_select="true">
    </div>
    <div id="loginBtn" class="g_id_signin" data-type="standard"></div>
    <button class="button" id="manageAccountBtn">管理帳戶</button>
    <div class="button-group">
      <button class="button" id="addAccountBtn">新增帳戶</button>
      <button class="button" id="logoutFromCard">登出帳戶</button>
    </div>
  </div>
</div>

<!-- Footer -->
<div id="footer">
  <p>© 2025 Elec Forge 版權所有</p>
</div>

  <script>
  const progressBar = document.getElementById('loading');
  const ctx = document.getElementById('myChart').getContext('2d');
  const loadingArea = document.getElementById('loading-area');

  let progress = 0;
  const interval = setInterval(() => {
    if (progress < 90) {
      progress += 10;
      progressBar.value = progress;
    } else {
      clearInterval(interval);
    }
  }, 100);

  fetch('/api/getUserTopicsCorrectRate', { method: 'GET', credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('無法取得資料');
      return response.json();
    })
    .then(data => {
      if (data.message !== "success" || !data.topics_correct_rate || !Array.isArray(data.topics_correct_rate)) {
        throw new Error("API 回傳資料格式錯誤");
      }

      const topicTitles = data.topicTitles || [];
      const rateObj = data.topics_correct_rate[0];
      const correctRates = Object.values(rateObj).map(v => parseFloat(v));

      const backgroundColors = correctRates.map(rate =>
        rate >= 50 ? 'rgba(30,61,140,1)' : 'rgba(255,74,74,1)'
      );
      const borderColors = correctRates.map(rate =>
        rate >= 50 ? 'rgba(30,61,140,1)' : 'rgba(255,74,74,1)'
      );

      progressBar.value = 100;
      setTimeout(() => {
        progressBar.style.display = 'none';
        loadingArea.style.display = 'none';
      }, 300);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topicTitles.map(title => {
            const text = title.title || title;
            return text.split(''); // ✅ 每個字一行，顯示為直排
          }),
          datasets: [{
            label: '答對率 (%)',
            data: correctRates,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1,
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: '答對率 (%)',
                font: {
                  size: 16
                }
              }
            },
            x: {
              title: {
                display: true,
                text: '單元名稱',
                font: {
                  size: 16
                }
              },
              ticks: {
                font: {
                  size: 14
                },
                maxRotation: 0,
                minRotation: 0
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => ctx.raw + '%'
              }
            },
            legend: {
              display: false
            }
          }
        }
      });
    })
    .catch(error => {
      progressBar.style.display = 'none';
      loadingArea.innerHTML = `<span style="color: red;">載入圖表失敗：${error.message}</span>`;
      console.error(error);
    });
</script>


  <script src="../static/script.js"></script>
</body>
</html>
